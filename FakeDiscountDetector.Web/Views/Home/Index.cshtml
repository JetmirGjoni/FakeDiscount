@using FakeDiscountDetector.Web.ViewModels
@model PaginatedList<Product>

@{
    ViewData["Title"] = "Dashboard";
    var fakeDiscounts = ViewBag.FakeDiscounts as List<Product>;
    var totalProducts = Model.TotalPages * 12; 
    var fakeCount = fakeDiscounts?.Count ?? 0;
}


<div class="bg-surface rounded-custom shadow-custom p-5 mb-5 text-center animate-fade-in-up" style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white;">
    <h1 class="display-4 fw-bold mb-3">Fake Discount Detector</h1>
    <p class="lead mb-4" style="opacity: 0.9;">Track prices, spot fake deals, and shop smarter.</p>


    <div class="row justify-content-center mb-4 animate-fade-in-up delay-100">
        <div class="col-md-6">
            <form asp-action="Index" method="get" class="d-flex gap-2 position-relative">
                <input type="text" id="searchInput" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control form-control-lg" placeholder="Search products..." autocomplete="off" />
                <button type="submit" class="btn btn-light btn-lg text-primary fw-bold">Search</button>
                @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"] as string))
                {
                        <a asp-action="Index" class="btn btn-outline-light btn-lg">Clear</a>
                }
                <div id="searchSuggestions" class="position-absolute w-100 bg-white shadow-lg rounded-bottom start-0" style="top: 100%; z-index: 9999; display: none;">
                  
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Biggest Discounts Section -->
@{
    var biggestDiscounts = ViewBag.BiggestDiscounts as List<Product>;
}

@if (biggestDiscounts != null && biggestDiscounts.Any())
{
        <div class="mb-5 animate-fade-in-up delay-200">
            <h3 class="fw-bold text-primary-custom mb-4"> Biggest Discounts Today</h3>
            <div class="discount-grid">
            @for (int i = 0; i < biggestDiscounts.Count; i++)
            {
                var p = biggestDiscounts[i];
                var latestPrice = p.PriceHistory.OrderByDescending(ph => ph.Timestamp).FirstOrDefault();
                var discount = latestPrice.OriginalPrice - latestPrice.Price;
                var percent = (int)((discount / latestPrice.OriginalPrice) * 100);

                        <div class="discount-card discount-item-@i">
                            <a asp-controller="Products" asp-action="Details" asp-route-id="@p.Id" class="text-decoration-none text-dark h-100 d-flex flex-column">
                                <div class="position-relative" style="height: 180px; background: white;">
                                    <div class="discount-badge">-@percent%</div>
                                     <img src="@p.ImageUrl" class="w-100 h-100" style="object-fit: contain; padding: 1rem;" alt="@p.Name">
                                </div>
                                <div class="p-3 bg-light border-top mt-auto">
                                    <h5 class="text-truncate" title="@p.Name">@p.Name</h5>
                                    <div class="d-flex align-items-end gap-2">
                                        <span class="h4 mb-0 fw-bold text-danger">@latestPrice.Price €</span>
                                        <span class="text-muted text-decoration-line-through">@latestPrice.OriginalPrice €</span>
                                    </div>
                                    <small class="text-muted">@p.StoreName</small>
                                </div>
                            </a>
                        </div>
            }
            </div>
        </div>
}

<!-- Alerts -->
@if (fakeDiscounts != null && fakeDiscounts.Any())
{
        <div class="alert alert-danger shadow-sm border-0 rounded-custom mb-5 animate-fade-in-up delay-300" role="alert">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="me-3 display-6">️</div>
                    <div>
                        <h4 class="alert-heading fw-bold mb-1">Potential Fake Discounts Detected!</h4>
                        <p class="mb-0">The following products on this page raised their prices recently just to show a "discount".</p>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#fakeDiscountList" aria-expanded="false" aria-controls="fakeDiscountList">
                    Toggle Details
                </button>
            </div>

            <div class="collapse mt-3" id="fakeDiscountList">
                <hr>
                <ul class="mb-0 ps-3">
                @foreach (var p in fakeDiscounts)
                {
                            <li>
                                <strong>@p.Name</strong> - 
                                <a asp-controller="Products" asp-action="Details" asp-route-id="@p.Id" class="alert-link">View Details</a>
                            </li>
                }
                </ul>
            </div>
        </div>
}


<div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in-up delay-300">
    <h3 class="fw-bold text-primary-custom mb-0">Tracked Products</h3>

  
    <div class="d-flex gap-3 align-items-center bg-white p-2 rounded shadow-sm border">
        <span class="fw-bold small text-uppercase text-muted">Filter by Store:</span>
        <div class="form-check mb-0">
            <input class="form-check-input store-filter" type="checkbox" value="Foleja" id="filterFoleja" checked>
            <label class="form-check-label" for="filterFoleja">Foleja</label>
        </div>
        <div class="form-check mb-0">
            <input class="form-check-input store-filter" type="checkbox" value="Gjirafa50" id="filterGjirafa" checked>
            <label class="form-check-label" for="filterGjirafa">Gjirafa50</label>
        </div>
    </div>
</div>

<div class="row g-4 animate-fade-in-up delay-300" id="productGrid">
    @foreach (var product in Model)
    {
        <div class="col-md-4 col-lg-3 product-card-wrapper" data-store="@product.StoreName">
            <div class="card h-100">
                <div class="position-relative">
                    <img src="@product.ImageUrl" class="card-img-top" alt="@product.Name" style="height: 200px; object-fit: contain; padding: 1.5rem;">
                    <span class="position-absolute top-0 end-0 m-2 badge bg-light text-dark shadow-sm border">@product.StoreName</span>
                </div>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title text-truncate mb-1" title="@product.Name">@product.Name</h6>
                    
                    <div class="mb-2">
                        @if (!string.IsNullOrEmpty(product.Category))
                        {
                            <span class="badge bg-info text-dark">@product.Category</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Uncategorized</span>
                            <form asp-controller="Products" asp-action="Classify" asp-route-id="@product.Id" method="post" class="d-inline ms-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm py-0 px-1" style="font-size: 0.7rem;">Classify</button>
                            </form>
                        }
                    </div>

                    <div class="mt-auto">
                        @{
                            var latestPrice = product.PriceHistory.OrderByDescending(p => p.Timestamp).FirstOrDefault();
                        }

                        @if (latestPrice != null)
                        {
                            <div class="d-flex align-items-end gap-2 mb-3">
                                <span class="h4 mb-0 fw-bold text-primary-custom">@latestPrice.Price €</span>
                                @if (latestPrice.OriginalPrice.HasValue)
                                {
                                    <span class="text-muted text-decoration-line-through small mb-1">@latestPrice.OriginalPrice €</span>
                                }
                            </div>
                        }

                        <div class="d-grid gap-2">
                            <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id" class="btn btn-primary btn-sm">View History</a>
                            <a href="@product.Url" target="_blank" class="btn btn-outline-secondary btn-sm">Visit Store</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


<div class="d-flex justify-content-center mt-5">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                <a class="page-link" asp-action="Index" 
                   asp-route-pageNumber="@(Model.PageIndex - 1)"
                   asp-route-searchString="@ViewData["CurrentFilter"]">Previous</a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                // Show first, last, and pages around current page
                if (i == 1 || i == Model.TotalPages || (i >= Model.PageIndex - 2 && i <= Model.PageIndex + 2))
                {
                             <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                <a class="page-link" asp-action="Index" 
                                   asp-route-pageNumber="@i"
                                   asp-route-searchString="@ViewData["CurrentFilter"]">@i</a>
                            </li>
                }
                else if (i == Model.PageIndex - 3 || i == Model.PageIndex + 3)
                {
                             <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                }
            }

            <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                <a class="page-link" asp-action="Index" 
                   asp-route-pageNumber="@(Model.PageIndex + 1)"
                   asp-route-searchString="@ViewData["CurrentFilter"]">Next</a>
            </li>
        </ul>
    </nav>
</div>

@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const checkboxes = document.querySelectorAll('.store-filter');
                const products = document.querySelectorAll('.product-card-wrapper');

                function filterProducts() {
                    const selectedStores = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    products.forEach(product => {
                        const store = product.getAttribute('data-store');
                        if (selectedStores.includes(store)) {
                            product.style.display = 'block';
                        } else {
                            product.style.display = 'none';
                        }
                    });
                }

                checkboxes.forEach(cb => {
                    cb.addEventListener('change', filterProducts);
                });

                // Search Autocomplete
                const searchInput = document.getElementById('searchInput');
                const suggestionsBox = document.getElementById('searchSuggestions');

                searchInput.addEventListener('input', function() {
                    const term = this.value;
                    if (term.length < 3) {
                        suggestionsBox.style.display = 'none';
                        return;
                    }

                    fetch(`/Home/SearchSuggestions?term=${encodeURIComponent(term)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                suggestionsBox.innerHTML = '';
                                const list = document.createElement('div');
                                list.className = 'list-group list-group-flush text-start';

                                data.forEach(item => {
                                    const a = document.createElement('a');
                                    a.href = `/Products/Details/${item.id}`;
                                    a.className = 'list-group-item list-group-item-action d-flex align-items-center gap-3 p-2';
                                    a.innerHTML = `
                                        <img src="${item.imageUrl}" style="width: 40px; height: 40px; object-fit: contain;" class="rounded border">
                                        <div class="flex-grow-1 text-truncate">
                                            <div class="fw-bold text-truncate">${item.label}</div>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">${item.price} €</span>
                                    `;
                                    list.appendChild(a);
                                });

                                suggestionsBox.appendChild(list);
                                suggestionsBox.style.display = 'block';
                            } else {
                                suggestionsBox.style.display = 'none';
                            }
                        });
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                        suggestionsBox.style.display = 'none';
                    }
                });
            });
        </script>
}
